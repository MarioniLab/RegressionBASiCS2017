---
title: "Residual over-dispersion and over-dispersion estimates"
author: "Nils Eling"
date: "27/11/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Compare residual and over-dispersion and residual over-dispersion parameters

This script recreates Figure 1.

Here we compare the posterior parameter estimates after running the regression model.
The over-dispersion estimates are confounded by mean expression while residual
over-dispersion estimates are uncorrelated to $\mu_i$.

```{r}
# Read in libraries
library(BASiCS)
library(cowplot)

# Load MCMC chains from all datasets
MCMCs <- readRDS("Results/Testing/Tdist/All_datasets.rds")

# Show the uncorrected over-dispersion values plotted against mean expression
uncorrected.fit <- showFit(MCMCs$MCMC_Dict_12_1.2_5_reg.rds) + ylim(c(-5,12)) + xlim(c(-1, 17))

# Show the corrected residual over-dispersion values plotted against mean expression
corrected.fit <- ggplot(data.frame(mu = colMedians(MCMCs$MCMC_Dict_12_1.2_5_reg.rds@parameters$mu),
                             epsilon = colMedians(MCMCs$MCMC_Dict_12_1.2_5_reg.rds@parameters$epsilon))) + 
  geom_hex(aes(log(mu), epsilon), bins = 100) +
  scale_fill_gradientn("", colours = colorRampPalette(c("dark blue", "yellow", "dark red"))(100), guide=FALSE) +
  xlab("log(mu)") + ylab("epsilon") + theme_minimal(base_size = 15) + xlim(c(-1, 17)) +
  geom_abline(slope = 0, intercept = 0, colour="dark red")

# Create final figure
final <- plot_grid(NULL, NULL, uncorrected.fit, corrected.fit, ncol = 2, nrow = 3, 
                   align = "vh", labels = "AUTO")

# Save final figure
ggsave(filename = "Manuscript/Figures/Fig1.pdf", plot = final, width = 5, height = 8)
```
