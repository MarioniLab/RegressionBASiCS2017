---
title: "Parameter estimation of varying cell population size."
author: "Nils Eling"
date: "27/11/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Effect of sample size on mean and over-dispersion estimates

This script recreates Figure 2 and Figure S2.

CA1 pyramidal neuron cells were subsetted to 50-500 cells and the regression 
as well as non-regression model were used to estimate parameters. 
These parameters are stored in .txt files. 
Parameters estimated on 939 cells is used as pseudo ground truth for comparison.

We will first look at the values for $\mu_i$

```{r}
# Read in libraries
library(cowplot)
library(BASiCS)
library(plyr)

Data.new <- as.data.frame(readRDS("Results/Testing/Tdist/Downsampling_Zeisel.rds"))
Data.old <- as.data.frame(readRDS("Results/Testing/Tdist/Downsampling_Zeisel_old.rds"))

# Collect mus, deltas and epsilons in data.frame
# Split into highly, medium and lowly expressed genes

# Offset correction
Offset <- function(mu_real, mu_sim){
  OS <- sum(mu_real)/sum(mu_sim) 
  mu_sim = mu_sim * OS
  print(OS)
  return(mu_sim)
}

# Ground truth parameters
mu_real <- Data.old$MCMC_939_1.rds_mu

Data.new[,seq(1,213, 3)] <- apply(Data.new[,seq(1,213, 3)], 2, function(n){
  Offset(mu_real, n)
})
Data.old[,seq(1,142, 2)] <- apply(Data.old[,seq(1,142, 2)], 2, function(n){
  Offset(mu_real, n)
})

# Split genes into lowly, medium and highly expressing for new and old model
df.mu <- matrix(data=NA, ncol = 3, nrow = 8*30*2)
colnames(df.mu) <- c("Median", "Lower", "Upper")
idx <- 1
counter <- 1

# We split the genes at the 33% and 66% quantile
lower <- quantile(log(mu_real), 0.33)
higher <- quantile(log(mu_real), 0.66)

# We collect the median and the central 50% quantile
for(i in seq(1,213, 3)){
  cur_mu_new <- log(Data.new[,i])
  cur_mu_old <- log(Data.old[,idx])
  
  df.mu[counter,1] <- median(cur_mu_old[log(mu_real) < lower])
  df.mu[counter+1,1] <- median(cur_mu_old[log(mu_real) > lower & log(mu_real) < higher])
  df.mu[counter+2,1] <- median(cur_mu_old[log(mu_real) > higher])
  
  df.mu[counter+3,1] <- median(cur_mu_new[log(mu_real) < lower])
  df.mu[counter+4,1] <- median(cur_mu_new[log(mu_real) > lower & log(mu_real) < higher])
  df.mu[counter+5,1] <- median(cur_mu_new[log(mu_real) > higher])
  
  df.mu[counter,2:3] <- quantile(cur_mu_old[log(mu_real) < lower], c(0.25,0.75))
  df.mu[counter+1,2:3] <- quantile(cur_mu_old[log(mu_real) > lower & log(mu_real) < higher], c(0.25,0.75))
  df.mu[counter+2,2:3] <- quantile(cur_mu_old[log(mu_real) > higher], c(0.25,0.75))
  
  df.mu[counter+3,2:3] <- quantile(cur_mu_new[log(mu_real) < lower], c(0.25,0.75))
  df.mu[counter+4,2:3] <- quantile(cur_mu_new[log(mu_real) > lower & log(mu_real) < higher], c(0.25,0.75))
  df.mu[counter+5,2:3] <- quantile(cur_mu_new[log(mu_real) > higher], c(0.25,0.75))
  counter <- counter+6
  idx = idx+2
}

# Create collapsed data.frame
df.mu.df <- as.data.frame(df.mu)
df.mu.df$NoCells <- factor(rep(c(100, 150, 200, 250, 300, 500, 50, 939), each=60), 
                             levels = c(50, 100, 150, 200, 250, 300, 500, 939))
df.mu.df$OldNew <- factor(c(rep(c("Old", "Old", "Old", "New", "New", "New"), 80)), 
                            levels = c("Old", "New"))
df.mu.df$LowHigh <- factor(rep(c("Low", "Medium", "High"), 160), 
                            levels = c("High", "Medium", "Low"))

df.mu.df <- df.mu.df[which(!is.na(df.mu.df[,1])),]

df.summary <- ddply(df.mu.df, c("NoCells", "OldNew", "LowHigh"), summarise,
                    Med = median(Median),
                    Lower = quantile(Median, 0.25),
                    Upper = quantile(Median, 0.75))

boxplot.mu <- ggplot(df.summary) + 
  geom_point(aes(NoCells, Med, colour=OldNew), size=2, position=position_dodge(width = 0.5)) + 
  geom_errorbar(aes(x = NoCells, ymin = Lower, ymax = Upper, colour=OldNew), width=0.25, position=position_dodge(width = 0.5)) +
  scale_color_manual(values = c("steelblue4", "coral3")) + ylab("log(mu)") + 
  xlab("Number of cells") + facet_grid(LowHigh~.)
```

Now we plot the values ofr $\delta_i$.

```{r}
# Split genes into lowly, medium and highly expressing for new and old model
df.delta <- matrix(data=NA, ncol = 3, nrow = 8*30*2)
colnames(df.delta) <- c("Median", "Lower", "Upper")
idx <- 2
counter <- 1

lower <- quantile(log(mu_real), 0.33)
higher <- quantile(log(mu_real), 0.66)

# We collect the median and the central 50% quantile
for(i in seq(2,213, 3)){
  cur_delta_new <- log(Data.new[,i])
  cur_delta_old <- log(Data.old[,idx])
  
  df.delta[counter,1] <- median(cur_delta_old[log(mu_real) < lower])
  df.delta[counter+1,1] <- median(cur_delta_old[log(mu_real) > lower & log(mu_real) < higher])
  df.delta[counter+2,1] <- median(cur_delta_old[log(mu_real) > higher])
  
  df.delta[counter+3,1] <- median(cur_delta_new[log(mu_real) < lower])
  df.delta[counter+4,1] <- median(cur_delta_new[log(mu_real) > lower & log(mu_real) < higher])
  df.delta[counter+5,1] <- median(cur_delta_new[log(mu_real) > higher])
  
  df.delta[counter,2:3] <- quantile(cur_delta_old[log(mu_real) < lower], c(0.25,0.75))
  df.delta[counter+1,2:3] <- quantile(cur_delta_old[log(mu_real) > lower & log(mu_real) < higher], c(0.25,0.75))
  df.delta[counter+2,2:3] <- quantile(cur_delta_old[log(mu_real) > higher], c(0.25,0.75))
  
  df.delta[counter+3,2:3] <- quantile(cur_delta_new[log(mu_real) < lower], c(0.25,0.75))
  df.delta[counter+4,2:3] <- quantile(cur_delta_new[log(mu_real) > lower & log(mu_real) < higher], c(0.25,0.75))
  df.delta[counter+5,2:3] <- quantile(cur_delta_new[log(mu_real) > higher], c(0.25,0.75))
  counter <- counter+6
  idx = idx+2
}

# Create collapsed data.frame
df.delta.df <- as.data.frame(df.delta)
df.delta.df$NoCells <- factor(rep(c(100, 150, 200, 250, 300, 500, 50, 939), each=60), 
                             levels = c(50, 100, 150, 200, 250, 300, 500, 939))
df.delta.df$OldNew <- factor(c(rep(c("Old", "Old", "Old", "New", "New", "New"), 80)), 
                            levels = c("Old", "New"))
df.delta.df$LowHigh <- factor(rep(c("Low", "Medium", "High"), 160), 
                            levels = c("High", "Medium", "Low"))

df.delta.df <- df.delta.df[which(!is.na(df.delta.df[,1])),]

df.summary <- ddply(df.delta.df, c("NoCells", "OldNew", "LowHigh"), summarise,
                    Med = median(Median),
                    Lower = quantile(Median, 0),
                    Upper = quantile(Median, 1))

boxplot.delta <- ggplot(df.summary) + 
  geom_point(aes(NoCells, Med, colour=OldNew), size=2, position=position_dodge(width = 0.5)) + 
  geom_errorbar(aes(x = NoCells, ymin = Lower, ymax = Upper, colour=OldNew), width=0.25, position=position_dodge(width = 0.5)) +
  scale_color_manual(values = c("steelblue4", "coral3")) + ylab("log(delta)") + 
  xlab("Number of cells") + facet_grid(LowHigh~.)
```

Compute correlation between 10 replicates for the downsampling experiment and 
the pseudo ground truth values for $\mu_i$.

```{r}
# Split genes into lowly, medium and highly expressing for new and old model
delta_real <- Data.old$MCMC_939_1.rds_delta
mu_real <- Data.old$MCMC_939_1.rds_mu

df.cors.mu <- matrix(data=NA, ncol=1, nrow=70*6, dimnames = list(NULL,"Correlation"))

idx <- 1
counter <- 1

for(i in seq(1,210, 3)){
  cur_mu_new <- Data.new[,i]
  cur_mu_old <- Data.old[,idx]
  cur_real_delta <- delta_real
  cur_real_mu <- mu_real
  
  idx = idx+2
    
  df.cors.mu[counter,] <- cor(log(cur_mu_new[log(cur_real_mu) < lower]),
                                     log(cur_real_mu[log(cur_real_mu) < lower]))
  df.cors.mu[counter+1,] <- cor(log(cur_mu_old[log(cur_real_mu) < lower]),
                                     log(cur_real_mu[log(cur_real_mu) < lower]))
  
  df.cors.mu[counter+2,] <- cor(log(cur_mu_new[log(cur_real_mu) > lower & log(cur_real_mu) < higher]),
                                     log(cur_real_mu[log(cur_real_mu) > lower & log(cur_real_mu) < higher]))
  df.cors.mu[counter+3,] <- cor(log(cur_mu_old[log(cur_real_mu) > lower & log(cur_real_mu) < higher]),
                                     log(cur_real_mu[log(cur_real_mu) > lower & log(cur_real_mu) < higher]))
  
  df.cors.mu[counter+4,] <- cor(cur_mu_new[log(cur_real_mu) > higher],
                                     cur_real_mu[log(cur_real_mu) > higher])
  df.cors.mu[counter+5,] <- cor(cur_mu_old[log(cur_real_mu) > higher],
                                     cur_real_mu[log(cur_real_mu) > higher])
  
  counter <- counter+6
}

# Create collapsed data.frame
df.cors.mu <- as.data.frame(df.cors.mu)

df.cors.mu$NoCells <- factor(rep(c(100, 150, 200, 250, 300, 500, 50), each=60))
df.cors.mu$OldNew <- factor(c(rep(c("New", "Old"), 210)))
df.cors.mu$LowHigh <- factor(rep(c("Low", "Low", "Medium", "Medium", "High", "High"), 70))

df.summary <- ddply(df.cors.mu, c("NoCells", "OldNew", "LowHigh"), summarise,
                    Med = median(Correlation),
                    Lower = quantile(Correlation, 0),
                    Upper = quantile(Correlation, 1))

df.summary$OldNew <- factor(df.summary$OldNew, levels=c("Old", "New"))
df.summary$LowHigh <- factor(df.summary$LowHigh, levels=c("High", "Medium", "Low"))

boxplot.cors.mu <- ggplot(df.summary) + 
  geom_point(aes(NoCells, Med, colour=OldNew), size=3, position=position_dodge(width = 0.5)) + 
  geom_errorbar(aes(x = NoCells, ymin = Lower, ymax = Upper, colour=OldNew), width=0.25, position=position_dodge(width = 0.5)) + ylim(0.5,1) +
  scale_color_manual(values = c("steelblue4", "coral3")) + ylab("log(delta)") + 
  xlab("Number of cells") + facet_grid(LowHigh~.)
```

Compute correlation between 10 replicates for the downsampling experiment and 
the ground truth values for $\delta_i$.

```{r}
# Split genes into lowly, medium and highly expressing for new and old model
delta_real <- Data.old$MCMC_939_1.rds_delta
mu_real <- Data.old$MCMC_939_1.rds_mu

df.cors.delta <- matrix(data=NA, ncol=1, nrow=70*6, dimnames = list(NULL,"Correlation"))

idx <- 2
counter <- 1

for(i in seq(2,210, 3)){
  cur_delta_new <- Data.new[,i]
  cur_delta_old <- Data.old[,idx]
  cur_real_delta <- delta_real
  cur_real_mu <- mu_real
  
  idx = idx+2
    
  df.cors.delta[counter,] <- cor(log(cur_delta_new[log(cur_real_mu) < lower]),
                                     log(cur_real_delta[log(cur_real_mu) < lower]))
  df.cors.delta[counter+1,] <- cor(log(cur_delta_old[log(cur_real_mu) < lower]),
                                     log(cur_real_delta[log(cur_real_mu) < lower]))
  
  df.cors.delta[counter+2,] <- cor(log(cur_delta_new[log(cur_real_mu) > lower & log(cur_real_mu) < higher]),
                                     log(cur_real_delta[log(cur_real_mu) > lower & log(cur_real_mu) < higher]))
  df.cors.delta[counter+3,] <- cor(log(cur_delta_old[log(cur_real_mu) > lower & log(cur_real_mu) < higher]),
                                     log(cur_real_delta[log(cur_real_mu) > lower & log(cur_real_mu) < higher]))
  
  df.cors.delta[counter+4,] <- cor(cur_delta_new[log(cur_real_mu) > higher],
                                     cur_real_delta[log(cur_real_mu) > higher])
  df.cors.delta[counter+5,] <- cor(cur_delta_old[log(cur_real_mu) > higher],
                                     cur_real_delta[log(cur_real_mu) > higher])
  
  counter <- counter+6
}

# Create collapse data.frame
df.cors.delta <- as.data.frame(df.cors.delta)

df.cors.delta$NoCells <- factor(rep(c(100, 150, 200, 250, 300, 500, 50), each=60))
df.cors.delta$OldNew <- factor(c(rep(c("New", "Old"), 210)))
df.cors.delta$LowHigh <- factor(rep(c("Low", "Low", "Medium", "Medium", "High", "High"), 70))

df.summary <- ddply(df.cors.delta, c("NoCells", "OldNew", "LowHigh"), summarise,
                    Med = median(Correlation),
                    Lower = quantile(Correlation, 0),
                    Upper = quantile(Correlation, 1))

df.summary$OldNew <- factor(df.summary$OldNew, levels=c("Old", "New"))
df.summary$LowHigh <- factor(df.summary$LowHigh, levels=c("High", "Medium", "Low"))

boxplot.cors.delta <- ggplot(df.summary) + 
  geom_point(aes(NoCells, Med, colour=OldNew), size=3, position=position_dodge(width = 0.5)) + 
  geom_errorbar(aes(x = NoCells, ymin = Lower, ymax = Upper, colour=OldNew), width=0.25, position=position_dodge(width = 0.5)) + ylim(0.4,1) +
  scale_color_manual(values = c("steelblue4", "coral3")) + ylab("log(delta)") + 
  xlab("Number of cells") + facet_grid(LowHigh~.)
```

Now look at the values for $\epsilon_i$.

```{r}
mu_real <- Data.old$MCMC_939_1.rds_mu
df.epsilon <- matrix(data=NA, ncol = 3, nrow = 8*30)
colnames(df.epsilon) <- c("Median", "Lower", "Upper")
counter <- 1

# We collect the median and the central 50% quantile
for(i in seq(3,213, 3)){
  cur_epsilon <- Data.new[,i]
  
  df.epsilon[counter,1] <- median(cur_epsilon[log(mu_real) < lower], na.rm = TRUE)
  df.epsilon[counter+1,1] <- median(cur_epsilon[log(mu_real) > lower & log(mu_real) < higher], na.rm = TRUE)
  df.epsilon[counter+2,1] <- median(cur_epsilon[log(mu_real) > higher], na.rm = TRUE)
  
  df.epsilon[counter,2:3] <- quantile(cur_epsilon[log(mu_real) < lower], c(0.25,0.75),na.rm = TRUE)
  df.epsilon[counter+1,2:3] <- quantile(cur_epsilon[log(mu_real) > lower & log(mu_real) < higher], 
                                        c(0.25,0.75),na.rm = TRUE)
  df.epsilon[counter+2,2:3] <- quantile(cur_epsilon[log(mu_real) > higher], c(0.25,0.75), na.rm = TRUE)
  
  counter <- counter+3
}

# Create collapsed data.frame
df.epsilon.df <- as.data.frame(df.epsilon)
df.epsilon.df$NoCells <- factor(rep(c(100, 150, 200, 250, 300, 500, 50, 939), each=30), 
                             levels = c(50, 100, 150, 200, 250, 300, 500, 939))
df.epsilon.df$LowHigh <- factor(rep(c("Low", "Medium", "High"), 80), 
                            levels = c("High", "Medium", "Low"))

df.epsilon.df <- df.epsilon.df[which(!is.na(df.epsilon.df[,1])),]

df.summary <- ddply(df.epsilon.df, c("NoCells", "LowHigh"), summarise,
                    Med = median(Median),
                    Lower = quantile(Median, 0),
                    Upper = quantile(Median, 1))

boxplot.epsilon <- ggplot(df.summary) + 
  geom_point(aes(NoCells, Med), colour="coral3", size=2, position=position_dodge(width = 0.5)) + 
  geom_errorbar(aes(x = NoCells, ymin = Lower, ymax = Upper), colour="coral3", width=0.25, position=position_dodge(width = 0.5)) + ylab("log(mu)") + ylim(c(-0.5,0.5)) +
  xlab("Number of cells") + facet_grid(LowHigh~.)

# Create final figures and save
final.main <- plot_grid(boxplot.mu, boxplot.delta, boxplot.epsilon, ncol = 3, nrow = 1, align = "h", labels = "AUTO")

ggsave("Manuscript/Figures/Fig2_Zeisel.pdf", plot = final.main, width = 12, height = 3)

final.supp <- plot_grid(boxplot.cors.mu, boxplot.cors.delta, ncol = 2, nrow = 1, align = "h", labels = "AUTO")

ggsave("Manuscript/Figures/FigS2_Zeisel.pdf", plot = final.supp, width = 11, height = 4)


```
